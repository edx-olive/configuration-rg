#!/bin/bash

# This file was generated by Ansible for {{ ansible_fqdn }}
# Do NOT modify this file by hand!

WORKDIR="{{ backup_work }}/{{ item[0]['name'] }}"

mkdir -p "${WORKDIR}"
chmod og-wrx "${WORKDIR}"

DATABASES="{{ item[0]['mysql_databases'] | default([], true) | join(' ') }}"
if [ -z "${DATABASES}" ]; then
    DATABASES="--all-databases"
else
    DATABASES="--databases ${DATABASES}"
fi

CONTAINER="{{ item[0]['mysql_container'] | default('mysql', true) }}"
USER="{{ item[0]['mysql_user'] | default('root', true) }}"
PASSWORD="{{ item[0]['mysql_password'] | default('', true) }}"

docker exec ${CONTAINER} mysqldump -u${USER} --password=${PASSWORD} --opt --skip-lock-tables --skip-extended-insert --max_allowed_packet=4194304 -C ${DATABASES} > "${WORKDIR}"/dump
DUMP_RETCODE=$?

{% for action in item[0]['pre_actions']|default([]) %}
{{ action }}
{% endfor %}

if test ${DUMP_RETCODE} -ne 0 ; then
    echo "Errors: mysqldump finished with errors. Please investigate"
    exit 1
fi
